import fs from 'node:fs';
import path from 'node:path';

const ROOT = process.cwd();
const OUTPUT_FILE = path.join(ROOT, 'services', 'generated-embedded-deps.js');
const CHECK_MODE = process.argv.includes('--check');

const SOURCE_FILES = {
  markdownIt: path.join(ROOT, 'lib', 'markdown-it.min.js'),
  highlight: path.join(ROOT, 'lib', 'highlight.min.js'),
  mathjax: path.join(ROOT, 'lib', 'mathjax-plugin.js'),
  theme: path.join(ROOT, 'themes', 'apple-theme.js'),
  converter: path.join(ROOT, 'converter.js'),
};

function readSource(filePath) {
  if (!fs.existsSync(filePath)) {
    throw new Error(`Missing dependency source file: ${filePath}`);
  }
  return fs.readFileSync(filePath, 'utf8');
}

function buildOutput() {
  const scripts = {};
  for (const [key, filePath] of Object.entries(SOURCE_FILES)) {
    scripts[key] = readSource(filePath);
  }

  return `// Auto-generated by scripts/generate-embedded-deps.mjs. Do not edit manually.
module.exports = {
  embeddedDependencyScripts: ${JSON.stringify(scripts, null, 2)},
};
`;
}

function main() {
  const content = buildOutput();
  const existing = fs.existsSync(OUTPUT_FILE)
    ? fs.readFileSync(OUTPUT_FILE, 'utf8')
    : null;

  if (CHECK_MODE) {
    if (existing !== content) {
      console.error('[generate-embedded-deps] generated output is out of sync.');
      console.error('[generate-embedded-deps] run: npm run generate:embedded');
      process.exit(1);
    }
    console.log('[generate-embedded-deps] embedded output is up to date.');
    return;
  }

  if (existing === content) {
    console.log('[generate-embedded-deps] no changes.');
    return;
  }

  fs.writeFileSync(OUTPUT_FILE, content, 'utf8');
  console.log(`[generate-embedded-deps] wrote ${OUTPUT_FILE}`);
}

main();
